# Tests that leader removal via a V1 config change with
# CampaignFollowerOnLeaderRemoval enabled asks a follower to campaign.

# We'll turn this back on after the boilerplate.
log-level none
----
ok

# Bootstrap n1, n2, n3.
add-nodes 3 voters=(1,2,3) index=2 campaign-follower-on-leader-removal=true
----
ok

campaign 1
----
ok

stabilize
----
ok (quiet)

log-level debug
----
ok

raft-state
----
1: StateLeader (Voter)
2: StateFollower (Voter)
3: StateFollower (Voter)

# Propose and replicate removal of n1 in a steady state with all caught-up
# followers.
propose-conf-change 1 v1=true
r1
----
INFO removing leader 1, requesting 2 to campaign on removal

raft-state
----
1: StateLeader (Voter)
2: StateFollower (Voter)
3: StateFollower (Voter)

stabilize 1
----
> 1 handling Ready
  Ready MustSync=true:
  Entries:
  1/4 EntryConfChange r1
  Messages:
  1->2 MsgApp Term:1 Log:1/3 Commit:3 Entries:[1/4 EntryConfChange r1]
  1->3 MsgApp Term:1 Log:1/3 Commit:3 Entries:[1/4 EntryConfChange r1]

stabilize 2 3
----
> 2 receiving messages
  1->2 MsgApp Term:1 Log:1/3 Commit:3 Entries:[1/4 EntryConfChange r1]
> 3 receiving messages
  1->3 MsgApp Term:1 Log:1/3 Commit:3 Entries:[1/4 EntryConfChange r1]
> 2 handling Ready
  Ready MustSync=true:
  Entries:
  1/4 EntryConfChange r1
  Messages:
  2->1 MsgAppResp Term:1 Log:0/4
> 3 handling Ready
  Ready MustSync=true:
  Entries:
  1/4 EntryConfChange r1
  Messages:
  3->1 MsgAppResp Term:1 Log:0/4

# n1 commits the removal.
stabilize 1
----
> 1 receiving messages
  2->1 MsgAppResp Term:1 Log:0/4
  3->1 MsgAppResp Term:1 Log:0/4
> 1 handling Ready
  Ready MustSync=false:
  HardState Term:1 Vote:1 Commit:4
  CommittedEntries:
  1/4 EntryConfChange r1
  Messages:
  1->2 MsgApp Term:1 Log:1/4 Commit:4
  1->3 MsgApp Term:1 Log:1/4 Commit:4
  INFO 1 switched to configuration voters=(2 3)

# When n2 applies the entry, it campaigns and wins.
stabilize
----
> 2 receiving messages
  1->2 MsgApp Term:1 Log:1/4 Commit:4
> 3 receiving messages
  1->3 MsgApp Term:1 Log:1/4 Commit:4
> 2 handling Ready
  Ready MustSync=false:
  HardState Term:1 Vote:1 Commit:4
  CommittedEntries:
  1/4 EntryConfChange r1
  Messages:
  2->1 MsgAppResp Term:1 Log:0/4
  INFO 2 switched to configuration voters=(2 3)
  INFO 2 is starting a new election at term 1
  INFO 2 became candidate at term 2
  INFO 2 [logterm: 1, index: 4] sent MsgVote request to 3 at term 2
> 3 handling Ready
  Ready MustSync=false:
  HardState Term:1 Vote:1 Commit:4
  CommittedEntries:
  1/4 EntryConfChange r1
  Messages:
  3->1 MsgAppResp Term:1 Log:0/4
  INFO 3 switched to configuration voters=(2 3)
> 1 receiving messages
  2->1 MsgAppResp Term:1 Log:0/4
  3->1 MsgAppResp Term:1 Log:0/4
> 2 handling Ready
  Ready MustSync=true:
  Lead:0 State:StateCandidate
  HardState Term:2 Vote:2 Commit:4
  Messages:
  2->3 MsgVote Term:2 Log:1/4
  INFO 2 received MsgVoteResp from 2 at term 2
  INFO 2 has received 1 MsgVoteResp votes and 0 vote rejections
> 3 receiving messages
  2->3 MsgVote Term:2 Log:1/4
  INFO 3 [term: 1] received a MsgVote message with higher term from 2 [term: 2]
  INFO 3 became follower at term 2
  INFO 3 [logterm: 1, index: 4, vote: 0] cast MsgVote for 2 [logterm: 1, index: 4] at term 2
> 3 handling Ready
  Ready MustSync=true:
  Lead:0 State:StateFollower
  HardState Term:2 Vote:2 Commit:4
  Messages:
  3->2 MsgVoteResp Term:2 Log:0/0
> 2 receiving messages
  3->2 MsgVoteResp Term:2 Log:0/0
  INFO 2 received MsgVoteResp from 3 at term 2
  INFO 2 has received 2 MsgVoteResp votes and 0 vote rejections
  INFO 2 became leader at term 2
> 2 handling Ready
  Ready MustSync=true:
  Lead:2 State:StateLeader
  Entries:
  2/5 EntryNormal ""
  Messages:
  2->3 MsgApp Term:2 Log:1/4 Commit:4 Entries:[2/5 EntryNormal ""]
> 3 receiving messages
  2->3 MsgApp Term:2 Log:1/4 Commit:4 Entries:[2/5 EntryNormal ""]
> 3 handling Ready
  Ready MustSync=true:
  Lead:2 State:StateFollower
  Entries:
  2/5 EntryNormal ""
  Messages:
  3->2 MsgAppResp Term:2 Log:0/5
> 2 receiving messages
  3->2 MsgAppResp Term:2 Log:0/5
> 2 handling Ready
  Ready MustSync=false:
  HardState Term:2 Vote:2 Commit:5
  CommittedEntries:
  2/5 EntryNormal ""
  Messages:
  2->3 MsgApp Term:2 Log:2/5 Commit:5
> 3 receiving messages
  2->3 MsgApp Term:2 Log:2/5 Commit:5
> 3 handling Ready
  Ready MustSync=false:
  HardState Term:2 Vote:2 Commit:5
  CommittedEntries:
  2/5 EntryNormal ""
  Messages:
  3->2 MsgAppResp Term:2 Log:0/5
> 2 receiving messages
  3->2 MsgAppResp Term:2 Log:0/5

# NB: n1 remains leader, since it doesn't step down on removal. See
# https://github.com/etcd-io/raft/pull/77 which addresses this.
raft-state
----
1: StateLeader (Non-Voter)
2: StateLeader (Voter)
3: StateFollower (Voter)
